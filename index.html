<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>DOJ Wallet</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      direction: rtl;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .info {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>کیف پول DOJ</h2>

  <button onclick="connectWallet()">اتصال به متامسک</button>
  <div class="info">
    <p><strong>آدرس کیف پول:</strong> <span id="wallet-address">---</span></p>
    <p><strong>موجودی DOJ:</strong> <span id="doj-balance">0</span></p>
    <p><strong>قیمت DOJ:</strong> <span id="doj-price">$---</span></p>
  </div>

  <button onclick="addDOJToken()">افزودن توکن به متامسک</button>

  <script>
    const DOJ_TOKEN = {
      address: "0x2815978CA263b0E82daEf5b2ba019Cc2FFc6097E",
      symbol: "DOJ",
      decimals: 18,
      image: "https://token-trusted.github.io/DOJ-TOKEN-ORIGINAL/logo.png"
    };

    let walletAddress;

    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        walletAddress = accounts[0];
        document.getElementById('wallet-address').textContent = walletAddress;
        fetchDOJBalance();
        fetchDOJPrice();
      } else {
        alert("MetaMask نصب نیست!");
      }
    }

    async function fetchDOJBalance() {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const abi = ["function balanceOf(address owner) view returns (uint256)"];
      const contract = new ethers.Contract(DOJ_TOKEN.address, abi, provider);
      const balance = await contract.balanceOf(walletAddress);
      const formatted = ethers.utils.formatUnits(balance, DOJ_TOKEN.decimals);
      document.getElementById('doj-balance').textContent = formatted;
    }

    async function fetchDOJPrice() {
      try {
        const res = await fetch("https://api.dexscreener.com/latest/dex/pairs/bsc/0xBAB73702F12f0152cC3FD7781EBBdd7891Fd1a20");
        const json = await res.json();
        const price = json.pair.priceUsd || "---";
        document.getElementById('doj-price').textContent = "$" + Number(price).toFixed(4);
      } catch (err) {
        document.getElementById('doj-price').textContent = "نامشخص";
      }
    }

    async function addDOJToken() {
      try {
        const wasAdded = await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: DOJ_TOKEN
          }
        });

        if (wasAdded) {
          alert('توکن DOJ اضافه شد!');
        } else {
          alert('کاربر رد کرد.');
        }
      } catch (error) {
        console.error(error);
      }
    }
  </script>

  <!-- ethers.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
</body>
</html>
